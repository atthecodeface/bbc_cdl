<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>CDL Modules: cdl/input_devices/src/ps2_host.cdl File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">CDL Modules
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_b89025be567f5b6d36b8bc23257fdaf4.html">cdl</a></li><li class="navelem"><a class="el" href="dir_cf89aefb5c350017542601e110fa08fc.html">input_devices</a></li><li class="navelem"><a class="el" href="dir_1e577da3a32b495b5de9ac226914dffb.html">src</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#namespaces">Namespaces</a> &#124;
<a href="#enum-members">Enumerations</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">ps2_host.cdl File Reference<div class="ingroups"><a class="el" href="group__ps2__host.html">ps2_host</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>PS2 interface for keyboard or mouse.  
<a href="#details">More...</a></p>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>PS2 interface for keyboard or mouse. </p>
<dl class="section copyright"><dt>Copyright</dt><dd>(C) 2016-2017, Gavin J Stark. All rights reserved.</dd>
<dd>
Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at <a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a>. Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.</dd></dl>
<p>CDL implementation of a PS2 interface host driver</p>
<p>The PS/2 interface is a bidirectional serial interface running on an open collector bus pin pair (clock and data).</p>
<p>A slave, such as a keyboard or mouse, owns the  pin, except for the one time that a host can usurp it to request transfer from host to slave. (Known as clock-inhibit)</p>
<p>A slave can present data to the host (this module) by:</p>
<p>0. Ensure clock is high for 50us</p><ol type="1">
<li>Pull data low; wait 5us to 25us.</li>
<li>Pull clock low; wait 30us.</li>
<li>Let clock rise; wait 15us.</li>
<li>Pull data low or let it rise; wait 15us (data bit 0)</li>
<li>Pull clock low; wait 30us.</li>
<li>Let clock rise; wait 15us. 7... Pull data low or let it rise; wait 15us (data bit 1..7) 8... Pull clock low; wait 30us 9... Let clock rise; wait 15us - repeat from 7 10... Pull data low or let it rise; wait 15us (parity bit) 11... Pull clock low; wait 30us 12... Let clock rise; wait 15us. 13... Let data rise; wait 15us (stop bit) 14... Pull clock low; wait 30us 15... Let clock rise; wait 15us.</li>
</ol>
<p>If the clock fails to rise on any of the pulses - because the host is driving it low (clock-inhibit) - the slave will have to retransmit the byte (and any other byte of a packet that it has already sent).</p>
<p>A host can present data to the slave with:</p><ol type="1">
<li>Pull clock low for 100us; start 15ms timeout</li>
<li>Pull data low, wait for 15us.</li>
<li>Let clock rise, wait for 15us.</li>
<li>Check the clock is high.</li>
<li>Wait for clock low</li>
<li>On clock low, wait for 10us, and set data to data bit 0</li>
<li>Wait for clock high</li>
<li>Wait for clock low 9... On clock low, wait for 10us, and set data to data bit 1..7 10... Wait for clock high 11... Wait for clock low</li>
<li>On clock low, wait for 10us, and set data to parity bit</li>
<li>Wait for clock high</li>
<li>Wait for clock low</li>
<li>On clock low, wait for 10us, let data rise (stop bit)</li>
<li>Wait for clock high</li>
<li>Wait for clock low</li>
<li>Wait for 10us, check that data is low (ack)</li>
</ol>
<p>A strategy is to run at (for example) ~3us per 'tick', and use that to look for valid data streams on the pins.</p>
<p>As a host, to receive data from the slave (the first target for the design), we have to:</p><ol type="1">
<li>Look for clock falling</li>
<li>If data is low, then assume this is a start bit. Set timeout timer.</li>
<li>Wait for clock falling. Clock in data bit 0</li>
<li>Wait for clock falling. Clock in data bit 1</li>
<li>Wait for clock falling. Clock in data bit 2</li>
<li>Wait for clock falling. Clock in data bit 3</li>
<li>Wait for clock falling. Clock in data bit 4</li>
<li>Wait for clock falling. Clock in data bit 5</li>
<li>Wait for clock falling. Clock in data bit 6</li>
<li>Wait for clock falling. Clock in data bit 7</li>
<li>Wait for clock falling. Clock in parity bit.</li>
<li>Wait for clock falling. Clock in stop bit.</li>
<li>Wait for clock high.</li>
<li>Validate data (stop bit 1, parity correct) </li>
</ol>
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:structps2__host_1_1t__clock__state"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ps2__host.html#structps2__host_1_1t__clock__state">ps2_host::t_clock_state</a></td></tr>
<tr class="separator:structps2__host_1_1t__clock__state"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structps2__host_1_1t__clock__combs"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ps2__host.html#structps2__host_1_1t__clock__combs">ps2_host::t_clock_combs</a></td></tr>
<tr class="separator:structps2__host_1_1t__clock__combs"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structps2__host_1_1t__ps2__input__state"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ps2__host.html#structps2__host_1_1t__ps2__input__state">ps2_host::t_ps2_input_state</a></td></tr>
<tr class="separator:structps2__host_1_1t__ps2__input__state"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structps2__host_1_1t__ps2__input__combs"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ps2__host.html#structps2__host_1_1t__ps2__input__combs">ps2_host::t_ps2_input_combs</a></td></tr>
<tr class="separator:structps2__host_1_1t__ps2__input__combs"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structps2__host_1_1t__rx__result"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ps2__host.html#structps2__host_1_1t__rx__result">ps2_host::t_rx_result</a></td></tr>
<tr class="separator:structps2__host_1_1t__rx__result"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structps2__host_1_1t__ps2__receive__state"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ps2__host.html#structps2__host_1_1t__ps2__receive__state">ps2_host::t_ps2_receive_state</a></td></tr>
<tr class="separator:structps2__host_1_1t__ps2__receive__state"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:structps2__host_1_1t__ps2__receive__combs"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ps2__host.html#structps2__host_1_1t__ps2__receive__combs">ps2_host::t_ps2_receive_combs</a></td></tr>
<tr class="separator:structps2__host_1_1t__ps2__receive__combs"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="namespaces"></a>
Namespaces</h2></td></tr>
<tr class="memitem:namespaceps2__host"><td class="memItemLeft" align="right" valign="top"> &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceps2__host.html">ps2_host</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="enum-members"></a>
Enumerations</h2></td></tr>
<tr class="memitem:ga7c3996da8fb536ccc310bbdccfe03d89"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ps2__host.html#ga7c3996da8fb536ccc310bbdccfe03d89">ps2_host::t_rx_action</a> { <br />
&#160;&#160;<a class="el" href="group__ps2__host.html#gga7c3996da8fb536ccc310bbdccfe03d89a54b26fd5d2a8661e7fbdfcaa23383597">ps2_host::action_rx_none</a>, 
<br />
&#160;&#160;<a class="el" href="group__ps2__host.html#gga7c3996da8fb536ccc310bbdccfe03d89ad57c3dca46e1eefbafe5c95d11c7f678">ps2_host::action_rx_start</a>, 
<br />
&#160;&#160;<a class="el" href="group__ps2__host.html#gga7c3996da8fb536ccc310bbdccfe03d89a8724386e29acdd518f81ce6c456dcfa9">ps2_host::action_rx_clock_finishing_data</a>, 
<br />
&#160;&#160;<a class="el" href="group__ps2__host.html#gga7c3996da8fb536ccc310bbdccfe03d89a63a094e661800dc8a1acd9755912222c">ps2_host::action_rx_clock_rising_in_bit</a>, 
<br />
&#160;&#160;<a class="el" href="group__ps2__host.html#gga7c3996da8fb536ccc310bbdccfe03d89a02d69ad4be276f6ae34f37d24091de3f">ps2_host::action_rx_clock_data</a>, 
<br />
&#160;&#160;<a class="el" href="group__ps2__host.html#gga7c3996da8fb536ccc310bbdccfe03d89a364f081b8beb73039f2aec3d46cf31d9">ps2_host::action_rx_acknowledge_timeout</a>, 
<br />
&#160;&#160;<a class="el" href="group__ps2__host.html#gga7c3996da8fb536ccc310bbdccfe03d89a80c6ad92b3cef300588cf1896550c586">ps2_host::action_rx_acknowledge_error</a>, 
<br />
&#160;&#160;<a class="el" href="group__ps2__host.html#gga7c3996da8fb536ccc310bbdccfe03d89aa223290f810125bd98828072559c7ad7">ps2_host::action_rx_error</a>, 
<br />
&#160;&#160;<a class="el" href="group__ps2__host.html#gga7c3996da8fb536ccc310bbdccfe03d89aeca4753a6761aaefbc2237a174c3b9f4">ps2_host::action_rx_timeout</a>
<br />
 }</td></tr>
<tr class="separator:ga7c3996da8fb536ccc310bbdccfe03d89"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga476d4424f57db94f02d472e6416bb393"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ps2__host.html#ga476d4424f57db94f02d472e6416bb393">ps2_host::t_receive_fsm</a> { <br />
&#160;&#160;<a class="el" href="group__ps2__host.html#gga476d4424f57db94f02d472e6416bb393ad05937b9b82333b0b6032260d1e91aa6">ps2_host::receive_fsm_idle</a>, 
<br />
&#160;&#160;<a class="el" href="group__ps2__host.html#gga476d4424f57db94f02d472e6416bb393a7d8f7b8b636623ca3e63643df01d5347">ps2_host::receive_fsm_data_bit_clock_low</a>, 
<br />
&#160;&#160;<a class="el" href="group__ps2__host.html#gga476d4424f57db94f02d472e6416bb393abc0059b0805b635608656250eaaf2476">ps2_host::receive_fsm_data_bit_clock_high</a>, 
<br />
&#160;&#160;<a class="el" href="group__ps2__host.html#gga476d4424f57db94f02d472e6416bb393aa9b062ba00598025f5cf5f9cee23af41">ps2_host::receive_fsm_error</a>, 
<br />
&#160;&#160;<a class="el" href="group__ps2__host.html#gga476d4424f57db94f02d472e6416bb393ad82c123821b738433389f7a47d67f862">ps2_host::receive_fsm_timeout</a>
<br />
 }</td></tr>
<tr class="separator:ga476d4424f57db94f02d472e6416bb393"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:ga2d739ddaf1117693b901abfa38f45405"><td class="memItemLeft" align="right" valign="top">constant integer&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__ps2__host.html#ga2d739ddaf1117693b901abfa38f45405">ps2_host::timeout_rx_data</a> =1000</td></tr>
<tr class="separator:ga2d739ddaf1117693b901abfa38f45405"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Sep 30 2018 17:21:43 for CDL Modules by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.11
</small></address>
</body>
</html>
