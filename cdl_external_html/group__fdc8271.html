<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>CDL Modules: fdc8271</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">CDL Modules
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Modules</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#files">Files</a>  </div>
  <div class="headertitle">
<div class="title">fdc8271</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="files"></a>
Files</h2></td></tr>
<tr class="memitem:fdc8271_8cdl"><td class="memItemLeft" align="right" valign="top">file &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="fdc8271_8cdl.html">fdc8271.cdl</a></td></tr>
<tr class="memdesc:fdc8271_8cdl"><td class="mdescLeft">&#160;</td><td class="mdescRight">CDL implementation of 8271 FDC. <br /></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<h2 class="groupheader">Modules</h2>
<a class="anchor" id="gac4b2b52dfcf6ec75a65749e6d74bdea3"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">module fdc8271::fdc8271 </td>
          <td>(</td>
          <td class="paramtype">clock&#160;</td>
          <td class="paramname"><em>clk</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">input bit&#160;</td>
          <td class="paramname"><em>reset_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">input bit&#160;</td>
          <td class="paramname"><em>chip_select_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">input bit&#160;</td>
          <td class="paramname"><em>read_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">input bit&#160;</td>
          <td class="paramname"><em>write_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">input bit&#160;</td>
          <td class="paramname"><em>address</em>[2], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">input bit&#160;</td>
          <td class="paramname"><em>data_in</em>[8], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">output bit&#160;</td>
          <td class="paramname"><em>data_out</em>[8], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">output bit&#160;</td>
          <td class="paramname"><em>irq_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">output bit&#160;</td>
          <td class="paramname"><em>data_req</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">input bit&#160;</td>
          <td class="paramname"><em>data_ack_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">output bit&#160;</td>
          <td class="paramname"><em>select</em>[2], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">input bit&#160;</td>
          <td class="paramname"><em>ready</em>[2], </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">output bit&#160;</td>
          <td class="paramname"><em>fault_reset</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">output bit&#160;</td>
          <td class="paramname"><em>write_enable</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">output bit&#160;</td>
          <td class="paramname"><em>seek_step</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">output bit&#160;</td>
          <td class="paramname"><em>direction</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">output bit&#160;</td>
          <td class="paramname"><em>load_head</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">output bit&#160;</td>
          <td class="paramname"><em>low_current</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">input bit&#160;</td>
          <td class="paramname"><em>track_0_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">input bit&#160;</td>
          <td class="paramname"><em>write_protect_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">input bit&#160;</td>
          <td class="paramname"><em>index_n</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">output <a class="el" href="bbc__micro__types_8h.html#structt__bbc__floppy__op">t_bbc_floppy_op</a>&#160;</td>
          <td class="paramname"><em>bbc_floppy_op</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">input <a class="el" href="bbc__micro__types_8h.html#structt__bbc__floppy__response">t_bbc_floppy_response</a>&#160;</td>
          <td class="paramname"><em>bbc_floppy_response</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Diskettes had a standard format, with up to 80 (or so) tracks, each with a fixed layout</p>
<p>Each track would 'start' at the index marker, with a sync gap; the track then contained 'N' sectors each with an ID, a sync gap, data and another sync gap.</p>
<p>At the end there would be a final gap - but not a sync gap. A sync gap is 8hff's followed by six 8h00's. The final gap is all 8hff.</p>
<p>What this means is that effectively a track is 1's until the first sector Each sector is 48 0's, then a sector ID (which starts with a 1) followed by 1's with about 48 0's separating the ID from the sector data. The sector data starts with a single marker byte (starting with a 1) followed by the data and a CRC, followed by 1's.</p>
<p>The 48 0's may not always be 48, and the 1's may vary too - these are effectively start/stop regions, which can be encroached on by variations in disk speed.</p>
<p>Bytes on the disk are stored with a high clock pulse every 4us, and a low or high data pulse in the middle (i.e. after 2us).</p>
<p>Each bit on the disk is normally 4us, and a track is notionally 8*5,208 bits, so 166,656us (basically 1/6th of a second). This is because the disk spins at 360rpm, 6rps. At 4us/bit, a byte is read a 32us/byte - this is the NMI response time.</p>
<p>Note that the index markers have gapped clocks, to identify them properly - but the data is guaranteed to have ones, so the disk will not have just zeros for the index markers.</p>
<p>A simple implementation of a disk system might just support the sector data with a fixed number of sectors. However, for more flexibility (and perhaps ease of hardware implementation here) an alternative approach can be taken. This is to have a sector descriptor memory, as well as a disk data memory.</p>
<p>The sector descriptor memory is indexed by track and sector number. Supporting up to 16 sectors per track means that a sector descriptor memory is addressed by {track[7;0], sector[4;0]} - an 11-bit address. The sector descriptor memory is indexed by physical sector - i.e. the position on the track. The sector descriptor memory contains the sector's logical sector number.</p>
<p>The sector descriptor (64 bits) must contain:</p>
<p>bit indicating it is valid (so that a max number of sectors &lt;16 can be used) start address in disk data memory of sector data (excluding the bottom 7 bits must be zero, since sectors are always a multiple of 128 bytes)</p>
<p>id address mark for sector (8 bits) (8hFE, clock pattern 8hc7) track number (7 bits) head number (1 bit) sector number (4 bits) sector length (2 bits, 0=&gt;128, 1=&gt;256, 2=&gt;512, 3=&gt;1024) disk data address mark (8 bits) (8hFB valid, 8hf8 deleted data) (in the sector data itself on the disk) bit indicating ID has bad CRC bit indicating data has bad CRC</p>
<p>A disk descriptor then needs a base address of sector descriptor data, a base address of disk data memory, a number of tracks. For emulation purposes, the disk descriptor also includes details on how realistic the timing should be. It should also have a 'valid' bit (0 if disk not loaded), and a 'write protect' bit</p>
<p>The NMI code is: 7 (NMI brk) 3 0xd00 PHA 4 0xd01 LDA &amp;FE28 ;; FDC Status/Command 2 0xd04 AND #&amp;1F 2 0xd06 CMP #&amp;03 2 0xd08 BNE LBCBA ... error handling 4 0xd0a LDA &amp;FE2B ;; FDC Data 4 0xd0d STA &amp;FFFF ;; Replaced with destination address 6 0xd10 INC 0xD0E 3 0xd13 BNE 0xd18</p><ul>
<li>0xd15 INC 0xD0F 4 0xd18 PLA 6 0xd19 RTI</li>
</ul>
<p>Total of 47 cycles, or 23.5us per byte for data transfers </p><pre class="fragment">On a real drive, each track has 5208 bytes.
  index mark
  post-index gap, 32 bytes (26 0xff, 6 0x00 sync)
  Numsectors * { id field, 7 bytes; post-id field gap 17 bytes (11 0xff, 6 0x00 sync); data field (n bytes); post-data field gap 33 bytes (27 0xff, 6 0x00 sync) }
  trailing gap (40 0xff, 6 0x00 sync)

id field is:
  id address mark
  track address (00-74, officially in 8271)
  head address (0 or 1)
  sector address (01-26)
  sector length (0=&gt;128, 1=&gt;256, 2=&gt;512)
  2 bytes CRC

data field is:
  data address mark
  N bytes data
  2 byte CRC</pre> <p>Command</p>
<p>command</p>
<p>Parameter</p>
<p>parameter</p>
<p>Write action</p>
<p>action</p>
<p>Status read</p>
<p>status</p>
<p>Result read</p>
<p>result</p>
<p>Seek track</p>
<p>track</p>
<p>Seek sector id</p>
<p>track</p>
<p>sector</p>
<p>Load head</p>
<p>track</p>
<p>Find index</p>
<p>track</p>
<p>Read id</p>
<p>track</p>
<p>Read data</p>
<p>track</p>
<p>sector</p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramdir">[in]</td><td class="paramname">clk</td><td></td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">reset_n</td><td>8271 has an active high reset, but... </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">chip_select_n</td><td>Active low chip select </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">read_n</td><td>Indicates a read transaction if asserted and chip selected </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">write_n</td><td>Indicates a write transaction if asserted and chip selected </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">address</td><td>Address of register being accessed </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">data_in</td><td>Data in (from CPU) </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">data_out</td><td>Read data out (to CPU) </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">irq_n</td><td>Was INT on the 8271, but that means something else now; active low interrupt </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">data_req</td><td></td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">data_ack_n</td><td></td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">select</td><td>drive select </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">ready</td><td>drive ready </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">fault_reset</td><td></td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">write_enable</td><td>High if the drive should write data </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">seek_step</td><td>High if the drive should step </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">direction</td><td>Direction of step </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">load_head</td><td>Enable drive head </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">low_current</td><td>Asserted for track&gt;=43 </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">track_0_n</td><td>Asserted low if the selected drive is on track 0 </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">write_protect_n</td><td>Asserted low if the selected drive is write-protected </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">index_n</td><td>Asserted low if the selected drive photodiode indicates start of track </td></tr>
    <tr><td class="paramdir">[out]</td><td class="paramname">bbc_floppy_op</td><td>Model drive operation, including write data </td></tr>
    <tr><td class="paramdir">[in]</td><td class="paramname">bbc_floppy_response</td><td>Parallel data read, specific to the model </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sun Mar 5 2017 18:00:43 for CDL Modules by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.8
</small></address>
</body>
</html>
